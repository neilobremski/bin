#!/usr/bin/env bash
# az-wi-comment — Add a markdown comment to an Azure DevOps work item.
#
# Usage:
#     az-wi-comment <work-item-id> [options] "markdown text"
#     echo "markdown text" | az-wi-comment <work-item-id> [options]
#
# Options:
#     --org <url>        Azure DevOps org URL (default: https://dev.azure.com/pay-i)
#     --project <name>   Project name (default: pay-i)
#     --image <path>     Upload image and append to comment (repeatable)
#
# Inline images:
#     Local file paths in markdown image syntax are automatically uploaded:
#         ![description](/path/to/screenshot.png)
#     The local path is replaced with the Azure DevOps attachment URL.
#     Use --image to append images without placing them in the text.
#
# Examples:
#     az-wi-comment 5060 "Bug confirmed."
#     az-wi-comment 5060 --image screenshot.png "Bug confirmed. See attached."
#     az-wi-comment 5060 '![proof](./screenshot.png) Bug confirmed.'
#     cat findings.md | az-wi-comment 5060
#
# Uses the REST API with multilineFieldsFormat to store comments as Markdown.
# The az CLI --discussion flag escapes markdown, so this script bypasses it.
#
# References:
#   https://learn.microsoft.com/en-us/rest/api/azure/devops/wit/attachments/create
#   https://github.com/Azure/azure-devops-cli-extension/issues/1473

set -euo pipefail

if [[ $# -lt 1 ]]; then
    sed -n '2,/^$/s/^# *//p' "$0"
    exit 1
fi

WORK_ITEM_ID="$1"; shift

ORG="https://dev.azure.com/pay-i"
PROJECT="pay-i"
COMMENT=""
IMAGES=()

# Parse --flags and collect the final positional arg as comment text
while [[ $# -gt 0 ]]; do
    case "$1" in
        --org)     ORG="$2"; shift 2 ;;
        --project) PROJECT="$2"; shift 2 ;;
        --image)   IMAGES+=("$2"); shift 2 ;;
        --)        shift; break ;;
        --*)       echo "Unknown option: $1" >&2; exit 1 ;;
        *)
            if [[ $# -eq 1 ]]; then
                COMMENT="$1"; shift
            else
                echo "Unexpected argument: $1" >&2; exit 1
            fi
            ;;
    esac
done

# Remaining args after -- (if any) joined as comment
if [[ $# -gt 0 ]]; then
    COMMENT="$*"
fi

# Fall back to stdin if no comment text given
if [[ -z "$COMMENT" ]]; then
    if [[ -t 0 ]]; then
        echo "Error: no comment text provided and stdin is a terminal." >&2
        exit 1
    fi
    COMMENT="$(cat)"
fi

# Get a bearer token for Azure DevOps
PAT=$(az account get-access-token \
    --resource 499b84ac-1321-427f-aa17-267ca6975798 \
    --query accessToken -o tsv 2>/dev/null)

if [[ -z "$PAT" ]]; then
    echo "Error: could not obtain access token. Run 'az login' first." >&2
    exit 1
fi

# upload_image <local-path> — uploads to ADO, prints the attachment URL
upload_image() {
    local filepath="$1"
    local filename
    filename=$(basename "$filepath")

    if [[ ! -f "$filepath" ]]; then
        echo "Error: image file not found: $filepath" >&2
        return 1
    fi

    local url
    url=$(curl -s -X POST \
        "${ORG}/${PROJECT}/_apis/wit/attachments?fileName=${filename}&api-version=7.1-preview.3" \
        -H "Authorization: Bearer $PAT" \
        -H "Content-Type: application/octet-stream" \
        --data-binary "@${filepath}" | jq -r '.url')

    if [[ -z "$url" || "$url" == "null" ]]; then
        echo "Error: failed to upload image: $filepath" >&2
        return 1
    fi

    echo "$url"
}

# Scan comment for ![alt](local-path) where local-path is an existing file.
# Upload each and replace with the ADO attachment URL.
while IFS= read -r match; do
    # Extract the path from the match (everything between parens)
    local_path="${match#*(}"
    local_path="${local_path%)}"

    # Skip URLs (http/https)
    if [[ "$local_path" == http://* || "$local_path" == https://* ]]; then
        continue
    fi

    # Skip if file doesn't exist
    if [[ ! -f "$local_path" ]]; then
        continue
    fi

    echo "Uploading inline image: $local_path" >&2
    ado_url=$(upload_image "$local_path") || continue
    # Replace the local path with the ADO URL in the comment
    COMMENT="${COMMENT//"($local_path)"/"($ado_url)"}"
done < <(grep -oE '!\[[^]]*\]\([^)]+\)' <<< "$COMMENT" || true)

# Append --image files to the end of the comment
for img in "${IMAGES[@]}"; do
    echo "Uploading appended image: $img" >&2
    ado_url=$(upload_image "$img") || continue
    filename=$(basename "$img")
    COMMENT="${COMMENT}

![${filename}](${ado_url})"
done

# Build JSON PATCH body: set System.History + mark it as Markdown
API_URL="${ORG}/${PROJECT}/_apis/wit/workItems/${WORK_ITEM_ID}?api-version=7.1-preview.3"

BODY=$(jq -n --arg txt "$COMMENT" '[
    {"op": "add", "path": "/fields/System.History", "value": $txt},
    {"op": "add", "path": "/multilineFieldsFormat/System.History", "value": "Markdown"}
]')

exec curl -s -X PATCH "$API_URL" \
    -H "Authorization: Bearer $PAT" \
    -H "Content-Type: application/json-patch+json" \
    -d "$BODY"
