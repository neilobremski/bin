#!/usr/bin/env python3
"""
az-pr-dump â€” Dump an Azure DevOps Pull Request to structured JSON.

Usage:
    az-pr-dump <pr-id> [--org <org-url>] [--project <project>] [--repo <repo>]
    az-pr-dump <pr-url>

Examples:
    az-pr-dump 5702
    az-pr-dump 5702 --org https://dev.azure.com/pay-i --project pay-i --repo pay-i
    az-pr-dump https://dev.azure.com/pay-i/pay-i/_git/pay-i/pullrequest/5702

Requires: az cli with devops extension (az extension add --name azure-devops)
"""

import argparse
import json
import re
import subprocess
import sys
from urllib.parse import urlparse


def parse_pr_url(url):
    """Extract org, project, repo, and PR ID from an Azure DevOps PR URL."""
    # https://dev.azure.com/{org}/{project}/_git/{repo}/pullrequest/{id}
    m = re.match(
        r"https://dev\.azure\.com/([^/]+)/([^/]+)/_git/([^/]+)/pullrequest/(\d+)",
        url,
    )
    if m:
        return {
            "org": f"https://dev.azure.com/{m.group(1)}",
            "project": m.group(2),
            "repo": m.group(3),
            "pr_id": int(m.group(4)),
        }
    raise ValueError(f"Could not parse Azure DevOps PR URL: {url}")


def az_invoke(area, resource, route_params, org, query_params=None):
    """Call az devops invoke and return parsed JSON."""
    cmd = [
        "az", "devops", "invoke",
        "--area", area,
        "--resource", resource,
        "--route-parameters", *[f"{k}={v}" for k, v in route_params.items()],
        "--organization", org,
        "--output", "json",
    ]
    if query_params:
        cmd += ["--query-parameters", *[f"{k}={v}" for k, v in query_params.items()]]
    result = subprocess.run(cmd, capture_output=True, text=True)
    if result.returncode != 0:
        print(f"Error running: {' '.join(cmd)}", file=sys.stderr)
        print(result.stderr, file=sys.stderr)
        sys.exit(1)
    return json.loads(result.stdout)


def fetch_pr(org, project, repo, pr_id):
    """Fetch the PR metadata."""
    return az_invoke(
        "git", "pullRequests",
        {"repositoryId": repo, "project": project, "pullRequestId": str(pr_id)},
        org,
    )


def fetch_threads(org, project, repo, pr_id):
    """Fetch all comment threads on a PR."""
    data = az_invoke(
        "git", "pullRequestThreads",
        {"repositoryId": repo, "project": project, "pullRequestId": str(pr_id)},
        org,
    )
    return data.get("value", [])


def fetch_iterations(org, project, repo, pr_id):
    """Fetch PR iterations (update rounds)."""
    data = az_invoke(
        "git", "pullRequestIterations",
        {"repositoryId": repo, "project": project, "pullRequestId": str(pr_id)},
        org,
    )
    return data.get("value", [])


def fetch_work_items(org, project, repo, pr_id):
    """Fetch work items linked to a PR."""
    data = az_invoke(
        "git", "pullRequestWorkItems",
        {"repositoryId": repo, "project": project, "pullRequestId": str(pr_id)},
        org,
    )
    return data.get("value", [])


def simplify_thread(thread):
    """Distill a thread down to the useful fields."""
    ctx = thread.get("threadContext")
    file_context = None
    if ctx:
        file_context = {
            "filePath": ctx.get("filePath"),
            "rightFileStart": ctx.get("rightFileStart"),
            "rightFileEnd": ctx.get("rightFileEnd"),
            "leftFileStart": ctx.get("leftFileStart"),
            "leftFileEnd": ctx.get("leftFileEnd"),
        }
        # Strip None values
        file_context = {k: v for k, v in file_context.items() if v is not None}

    comments = []
    for c in thread.get("comments", []):
        if c.get("isDeleted"):
            continue
        comments.append({
            "author": c.get("author", {}).get("displayName"),
            "content": c.get("content"),
            "commentType": c.get("commentType"),
            "publishedDate": c.get("publishedDate"),
        })

    return {
        "id": thread.get("id"),
        "status": thread.get("status"),
        "fileContext": file_context,
        "comments": comments,
        "isDeleted": thread.get("isDeleted", False),
    }


def simplify_pr(pr):
    """Distill PR metadata to useful fields."""
    return {
        "id": pr.get("pullRequestId"),
        "title": pr.get("title"),
        "description": pr.get("description"),
        "status": pr.get("status"),
        "createdBy": pr.get("createdBy", {}).get("displayName"),
        "creationDate": pr.get("creationDate"),
        "sourceRefName": pr.get("sourceRefName"),
        "targetRefName": pr.get("targetRefName"),
        "mergeStatus": pr.get("mergeStatus"),
        "reviewers": [
            {
                "displayName": r.get("displayName"),
                "vote": r.get("vote"),
                "isRequired": r.get("isRequired", False),
            }
            for r in pr.get("reviewers", [])
        ],
        "labels": [l.get("name") for l in pr.get("labels", [])],
        "url": pr.get("url"),
    }


def main():
    parser = argparse.ArgumentParser(
        description="Dump an Azure DevOps Pull Request to structured JSON.",
    )
    parser.add_argument(
        "pr", help="PR ID (integer) or full Azure DevOps PR URL",
    )
    parser.add_argument("--org", default=None, help="Azure DevOps org URL")
    parser.add_argument("--project", default=None, help="Project name")
    parser.add_argument("--repo", default=None, help="Repository name")

    args = parser.parse_args()

    # Determine PR coordinates
    if args.pr.startswith("http"):
        parsed = parse_pr_url(args.pr)
        org = args.org or parsed["org"]
        project = args.project or parsed["project"]
        repo = args.repo or parsed["repo"]
        pr_id = parsed["pr_id"]
    else:
        pr_id = int(args.pr)
        org = args.org or "https://dev.azure.com/pay-i"
        project = args.project or "pay-i"
        repo = args.repo or "pay-i"

    pr = fetch_pr(org, project, repo, pr_id)
    threads = fetch_threads(org, project, repo, pr_id)
    iterations = fetch_iterations(org, project, repo, pr_id)
    work_items = fetch_work_items(org, project, repo, pr_id)

    output = {
        "pullRequest": simplify_pr(pr),
        "iterations": [
            {
                "id": it.get("id"),
                "description": it.get("description"),
                "createdDate": it.get("createdDate"),
                "sourceRefCommit": (it.get("sourceRefCommit") or {}).get("commitId"),
            }
            for it in iterations
        ],
        "threads": [simplify_thread(t) for t in threads],
        "workItems": [
            {
                "id": wi.get("id"),
                "url": wi.get("url"),
            }
            for wi in work_items
        ],
    }

    json.dump(output, sys.stdout, indent=2)
    print()  # trailing newline


if __name__ == "__main__":
    main()
