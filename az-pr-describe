#!/usr/bin/env bash
# az-pr-describe â€” Set the description of an Azure DevOps Pull Request.
#
# Usage:
#     az-pr-describe <pr-id> [options] "markdown text"
#     echo "markdown text" | az-pr-describe <pr-id> [options]
#
# Options:
#     --org <url>        Azure DevOps org URL (default: https://dev.azure.com/pay-i)
#     --project <name>   Project name (default: pay-i)
#     --repo <name>      Repository name (default: pay-i)
#
# Examples:
#     az-pr-describe 5719 "## Summary\nBug fixes and improvements."
#     cat description.md | az-pr-describe 5719
#     az-pr-describe 5719 --repo payi-frontend "$(cat <<'EOF'
#     - **Feature A** does something
#     - **Feature B** does something else
#     EOF
#     )"
#
# Uses the REST API directly because `az repos pr update --description`
# has trouble with multi-line markdown and special characters.

set -euo pipefail

if [[ $# -lt 1 ]]; then
    sed -n '2,/^$/s/^# *//p' "$0"
    exit 1
fi

PR_ID="$1"; shift

ORG="https://dev.azure.com/pay-i"
PROJECT="pay-i"
REPO="pay-i"
DESCRIPTION=""

# Parse --flags and collect the final positional arg as description text
while [[ $# -gt 0 ]]; do
    case "$1" in
        --org)     ORG="$2"; shift 2 ;;
        --project) PROJECT="$2"; shift 2 ;;
        --repo)    REPO="$2"; shift 2 ;;
        --)        shift; break ;;
        --*)       echo "Unknown option: $1" >&2; exit 1 ;;
        *)
            if [[ $# -eq 1 ]]; then
                DESCRIPTION="$1"; shift
            else
                echo "Unexpected argument: $1" >&2; exit 1
            fi
            ;;
    esac
done

# Remaining args after -- (if any) joined as description
if [[ $# -gt 0 ]]; then
    DESCRIPTION="$*"
fi

# Fall back to stdin if no description text given
if [[ -z "$DESCRIPTION" ]]; then
    if [[ -t 0 ]]; then
        echo "Error: no description text provided and stdin is a terminal." >&2
        exit 1
    fi
    DESCRIPTION="$(cat)"
fi

# Get a bearer token for Azure DevOps
PAT=$(az account get-access-token \
    --resource 499b84ac-1321-427f-aa17-267ca6975798 \
    --query accessToken -o tsv 2>/dev/null)

if [[ -z "$PAT" ]]; then
    echo "Error: could not obtain access token. Run 'az login' first." >&2
    exit 1
fi

# PATCH the PR description via REST API
API_URL="${ORG}/${PROJECT}/_apis/git/repositories/${REPO}/pullrequests/${PR_ID}?api-version=7.1"

BODY=$(jq -n --arg desc "$DESCRIPTION" '{"description": $desc}')

RESPONSE=$(curl -s -w "\n%{http_code}" -X PATCH "$API_URL" \
    -H "Authorization: Bearer $PAT" \
    -H "Content-Type: application/json" \
    -d "$BODY")

HTTP_CODE=$(echo "$RESPONSE" | tail -1)
BODY_OUT=$(echo "$RESPONSE" | sed '$d')

if [[ "$HTTP_CODE" -ge 200 && "$HTTP_CODE" -lt 300 ]]; then
    echo "$BODY_OUT" | jq '{pullRequestId: .pullRequestId, title: .title, status: .status, description: .description}'
else
    echo "Error: API returned HTTP $HTTP_CODE" >&2
    echo "$BODY_OUT" >&2
    exit 1
fi
