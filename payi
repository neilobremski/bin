#!/usr/bin/env bash
#
# payi - General-purpose Pay-i API client
#
# Usage:
#   payi <application> [verb] <path> [--key value ...] [json]
#   echo '{"score":0.95}' | payi <application> put /api/v1/some/path
#
# The <application> argument selects a config file from ~/.payi-ingest/.
# Each config file should set PAYI_API_URL and PAYI_API_KEY.
#
# HTTP verb (get, post, put, patch, delete) is auto-detected from args.
# Defaults to GET when no body, POST when a body is present.
#
# Any --key value pairs are added as query string parameters.
# JSON payload is the last non-flag argument or piped via stdin.
#
# Examples:
#   payi my-app /api/v1/resources --category system.anthropic
#   payi my-app put /api/v1/use_cases/instances/uc/id1/kpis/score '{"score":0.95}'
#   echo '{}' | payi my-app post /api/v1/some/endpoint
#

set -euo pipefail

CONFIG_DIR="$HOME/.payi-ingest"

usage() {
  sed -n '3,/^$/s/^# \?//p' "$0" >&2
  if [ -d "$CONFIG_DIR" ]; then
    echo "Available applications:" >&2
    ls "$CONFIG_DIR" 2>/dev/null | sed 's/^/  /' >&2
  fi
  exit 1
}

to_lower() { echo "$1" | tr '[:upper:]' '[:lower:]'; }
to_upper() { echo "$1" | tr '[:lower:]' '[:upper:]'; }

[ $# -lt 2 ] && usage

app="$1"
shift

config="$CONFIG_DIR/$app"
if [ ! -f "$config" ]; then
  echo "payi: unknown application '$app'" >&2
  if [ -d "$CONFIG_DIR" ]; then
    echo "Available applications:" >&2
    ls "$CONFIG_DIR" 2>/dev/null | sed 's/^/  /' >&2
  fi
  exit 1
fi

source "$config"

if [ -z "${PAYI_API_URL:-}" ]; then
  echo "payi: PAYI_API_URL not set in $config" >&2
  exit 1
fi
if [ -z "${PAYI_API_KEY:-}" ]; then
  echo "payi: PAYI_API_KEY not set in $config" >&2
  exit 1
fi

# Parse args: verb, path, query params, json body
verb=""
path=""
query_string=""
json=""

while [ $# -gt 0 ]; do
  arg_lower="$(to_lower "$1")"
  case "$arg_lower" in
    get|post|put|patch|delete|head|options)
      verb="$arg_lower"
      shift
      ;;
    --help|-h)
      usage
      ;;
    --*)
      key="${1#--}"
      if [ $# -lt 2 ]; then
        echo "payi: missing value for $1" >&2
        exit 1
      fi
      encoded="$(printf '%s' "$2" | jq -sRr @uri)"
      if [ -n "$query_string" ]; then
        query_string="${query_string}&${key}=${encoded}"
      else
        query_string="${key}=${encoded}"
      fi
      shift 2
      ;;
    /*)
      path="$1"
      shift
      ;;
    *)
      json="$1"
      shift
      ;;
  esac
done

if [ -z "$path" ]; then
  echo "payi: no API path specified (must start with /)" >&2
  exit 1
fi

# Default verb
if [ -z "$verb" ]; then
  if [ -n "$json" ]; then
    verb="post"
  else
    verb="get"
  fi
fi

# Read from stdin only for body-expecting verbs when no JSON arg given
if [ -z "$json" ] && [ ! -t 0 ]; then
  case "$verb" in
    post|put|patch) json="$(cat)" ;;
  esac
fi

# Build URL with query string
url="${PAYI_API_URL}${path}"
if [ -n "$query_string" ]; then
  url="${url}?${query_string}"
fi

# Build and exec curl
verb_upper="$(to_upper "$verb")"
if [ -n "$json" ]; then
  exec curl -sk -X "$verb_upper" "$url" \
    -H "xProxy-api-key: $PAYI_API_KEY" \
    -H "Content-Type: application/json" \
    -d "$json"
else
  exec curl -sk -X "$verb_upper" "$url" \
    -H "xProxy-api-key: $PAYI_API_KEY"
fi
