#!/usr/bin/env bash
#
# payi - General-purpose Pay-i API client
#
# Usage:
#   payi <application> [verb] <path> [--header value] [-param value] [json]
#   echo '{"score":0.95}' | payi <application> put /api/v1/some/path
#
# The <application> argument selects a config file from ./.payi-ingest/
# (project-local) or ~/.payi-ingest/ (global). Local profiles take
# precedence. Set PAYI_CONFIG_DIR to override both with a single directory.
# Each config file should set PAYI_API_URL and PAYI_API_KEY.
#
# HTTP verb (get, post, put, patch, delete) is auto-detected from args.
# Defaults to GET when no body, POST when a body is present.
#
# --key value pairs are sent as HTTP headers (key: value).
# -key value pairs are added as query string parameters (?key=value).
# JSON payload is the last non-flag argument or piped via stdin.
#
# Run with no arguments to list configured applications.
#
# Examples:
#   payi my-app /api/v1/categories
#   payi my-app /api/v1/categories/system.anthropic/resources -limit 100
#   payi my-app post /api/v1/ingest --xProxy-UseCase-Name test '{"json":true}'
#   echo '{}' | payi my-app post /api/v1/some/endpoint
#

set -euo pipefail

GLOBAL_CONFIG_DIR="$HOME/.payi-ingest"
LOCAL_CONFIG_DIR=".payi-ingest"

resolve_config() {
  local app="$1"
  if [ -n "${PAYI_CONFIG_DIR:-}" ]; then
    echo "$PAYI_CONFIG_DIR/$app"
  elif [ -f "$LOCAL_CONFIG_DIR/$app" ]; then
    echo "$LOCAL_CONFIG_DIR/$app"
  else
    echo "$GLOBAL_CONFIG_DIR/$app"
  fi
}

list_apps() {
  if [ -n "${PAYI_CONFIG_DIR:-}" ]; then
    if [ -d "$PAYI_CONFIG_DIR" ]; then
      echo "Available applications:" >&2
      for f in "$PAYI_CONFIG_DIR"/*; do
        [ -f "$f" ] || continue
        name="$(basename "$f")"
        first="$(head -1 "$f")"
        if [[ "$first" == \#* ]]; then
          printf "  %-14s %s\n" "$name" "$first" >&2
        else
          printf "  %s\n" "$name" >&2
        fi
      done
    fi
    return
  fi

  local -A seen
  local lines=()

  if [ -d "$LOCAL_CONFIG_DIR" ]; then
    for f in "$LOCAL_CONFIG_DIR"/*; do
      [ -f "$f" ] || continue
      name="$(basename "$f")"
      seen["$name"]=1
      first="$(head -1 "$f")"
      if [[ "$first" == \#* ]]; then
        lines+=("$(printf "  %-14s %-9s %s" "$name" "(local)" "$first")")
      else
        lines+=("$(printf "  %-14s %s" "$name" "(local)")")
      fi
    done
  fi

  if [ -d "$GLOBAL_CONFIG_DIR" ]; then
    for f in "$GLOBAL_CONFIG_DIR"/*; do
      [ -f "$f" ] || continue
      name="$(basename "$f")"
      [ -n "${seen[$name]+x}" ] && continue
      first="$(head -1 "$f")"
      if [[ "$first" == \#* ]]; then
        lines+=("$(printf "  %-14s %-9s %s" "$name" "(global)" "$first")")
      else
        lines+=("$(printf "  %-14s %s" "$name" "(global)")")
      fi
    done
  fi

  if [ ${#lines[@]} -gt 0 ]; then
    echo "Available applications:" >&2
    printf '%s\n' "${lines[@]}" >&2
  fi
}

usage() {
  sed -n '3,/^$/s/^# \?//p' "$0" >&2
  list_apps
  exit 1
}

to_lower() { echo "$1" | tr '[:upper:]' '[:lower:]'; }
to_upper() { echo "$1" | tr '[:lower:]' '[:upper:]'; }

if [ $# -eq 0 ]; then
  list_apps
  exit 0
fi

[ $# -lt 2 ] && usage

app="$1"
shift

config="$(resolve_config "$app")"
if [ ! -f "$config" ]; then
  echo "payi: unknown application '$app'" >&2
  list_apps
  exit 1
fi

source "$config"

if [ -z "${PAYI_API_URL:-}" ]; then
  echo "payi: PAYI_API_URL not set in $config" >&2
  exit 1
fi
if [ -z "${PAYI_API_KEY:-}" ]; then
  echo "payi: PAYI_API_KEY not set in $config" >&2
  exit 1
fi

# Parse args: verb, path, headers, query params, json body
verb=""
path=""
query_string=""
headers=()
json=""

while [ $# -gt 0 ]; do
  arg_lower="$(to_lower "$1")"
  case "$arg_lower" in
    get|post|put|patch|delete|head|options)
      verb="$arg_lower"
      shift
      ;;
    --help)
      usage
      ;;
    --*)
      key="${1#--}"
      if [ $# -lt 2 ]; then
        echo "payi: missing value for $1" >&2
        exit 1
      fi
      headers+=(-H "$key: $2")
      shift 2
      ;;
    -h)
      usage
      ;;
    -*)
      key="${1#-}"
      if [ $# -lt 2 ]; then
        echo "payi: missing value for $1" >&2
        exit 1
      fi
      encoded="$(printf '%s' "$2" | jq -sRr @uri)"
      if [ -n "$query_string" ]; then
        query_string="${query_string}&${key}=${encoded}"
      else
        query_string="${key}=${encoded}"
      fi
      shift 2
      ;;
    /*)
      path="$1"
      shift
      ;;
    *)
      json="$1"
      shift
      ;;
  esac
done

if [ -z "$path" ]; then
  echo "payi: no API path specified (must start with /)" >&2
  exit 1
fi

# Default verb
if [ -z "$verb" ]; then
  if [ -n "$json" ]; then
    verb="post"
  else
    verb="get"
  fi
fi

# Read from stdin only for body-expecting verbs when no JSON arg given
if [ -z "$json" ] && [ ! -t 0 ]; then
  case "$verb" in
    post|put|patch) json="$(cat)" ;;
  esac
fi

# Build URL with query string
url="${PAYI_API_URL}${path}"
if [ -n "$query_string" ]; then
  url="${url}?${query_string}"
fi

# Build and exec curl
verb_upper="$(to_upper "$verb")"
if [ -n "$json" ]; then
  exec curl -sk -X "$verb_upper" "$url" \
    -H "xProxy-api-key: $PAYI_API_KEY" \
    -H "Content-Type: application/json" \
    ${headers[@]+"${headers[@]}"} \
    -d "$json"
else
  exec curl -sk -X "$verb_upper" "$url" \
    -H "xProxy-api-key: $PAYI_API_KEY" \
    ${headers[@]+"${headers[@]}"}
fi
