#!/usr/bin/env bash

# Script to extract the last frame from a video file using ffmpeg
# Usage: last-frame <video_file> [--output|-o <output_file>]

set -e

# Function to display usage
usage() {
  echo "Usage: $0 <video_file> [--output|-o <output_file>]"
  echo ""
  echo "Extract the last frame from a video file."
  echo ""
  echo "Arguments:"
  echo "  video_file              Path to the input video file"
  echo "  --output, -o FILE       Output filename (default: last-frame-YYYY-MM-DD-hhmmss.png)"
  exit 1
}

# Check if at least one argument is provided
if [ $# -eq 0 ]; then
  usage
fi

# Parse arguments
VIDEO_FILE=""
OUTPUT_FILE=""

while [ $# -gt 0 ]; do
  case "$1" in
    --output|-o)
      OUTPUT_FILE="$2"
      shift 2
      ;;
    -*)
      echo "Unknown option: $1"
      usage
      ;;
    *)
      if [ -z "$VIDEO_FILE" ]; then
        VIDEO_FILE="$1"
      else
        echo "Error: Multiple video files specified"
        usage
      fi
      shift
      ;;
  esac
done

# Check if video file was provided
if [ -z "$VIDEO_FILE" ]; then
  echo "Error: No video file specified"
  usage
fi

# Check if video file exists
if [ ! -f "$VIDEO_FILE" ]; then
  echo "Error: Video file not found: $VIDEO_FILE"
  exit 1
fi

# Set default output filename if not specified
if [ -z "$OUTPUT_FILE" ]; then
  TIMESTAMP=$(date +"%Y-%m-%d-%H%M%S")
  OUTPUT_FILE="last-frame-${TIMESTAMP}.png"
fi

# Extract the last frame using ffmpeg
echo "Extracting last frame from: $VIDEO_FILE"
ffmpeg -sseof -1 -i "$VIDEO_FILE" -update 1 -q:v 1 -frames:v 1 "$OUTPUT_FILE"

echo "Last frame saved to: $OUTPUT_FILE"
